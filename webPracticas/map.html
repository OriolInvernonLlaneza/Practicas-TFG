<!DOCTYPE html>
<meta charset="utf-8">
<style>
    #toggle {
        position: absolute;
        right: 15px;
        top: 15px;
        z-index: 100;
    }

    .map path {
        fill: #eee;
        stroke: #fff;
        stroke-width: 2;
    }

    .links line {
        stroke: #679;
        stroke-opacity: 0.25;
    }

    .nodes circle {
        fill: #679;
        stroke: #235;
        stroke-width: 2;
    }

    div.tooltip {
        position: absolute;
        text-align: center;
        width: 60px;
        height: 28px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }
</style>

<body>
    <script src="//d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="js/d3-tip.js"></script>
    <p id="demo"></p>
    <script>
        var width = 960,
            height = 480;

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        // remove any previous graphs
        svg.selectAll(".g-main").remove();

        // create main frame
        var gMain = svg.append("g")
            .classed("g-main", true);

        // append white rect to frame
        var rect = gMain.append("rect")
            .attr("width", width)
            .attr("height", height)
            .style("fill", "white");

        // append draw    
        var gDraw = gMain.append("g");

        //define arrows
        gDraw.append("defs").append("marker")
            .attr("id", "arrow")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 20)
            .attr("refY", 0)
            .attr("markerWidth", 1)
            .attr("markerHeight", 1)
            .attr("orient", "auto")
            .style("stroke-width", 0)
            .append("gDraw:path")
            .attr("d", "M0,-5L10,0L0,5")
            .style("stroke-width", 0);

        // zoom list
        function zoomed() {
            gMain.attr("transform", d3.event.transform); // transforms drawing with zoom event
        }

        var zoom = d3.zoom() // Creates new zoom behavior (obj and func) https://github.com/_d3/_d3-zoom
            .on("zoom", zoomed); // add listener

        gMain.call(zoom);

        var projection = d3.geoEquirectangular() //d3 projection type
            .center([8, 48]) //center around GER
            .scale(width); //zoom on europe

        var path = d3.geoPath().projection(projection);

        var graticule = d3.geoGraticule();

        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        d3.json("resources/world-50m.json", function (error, world) { //load map

            gDraw.append("g")
                .attr("class", "land")
                .selectAll("path")
                .data([topojson.feature(world, world.objects.land)])
                .enter().append("path")
                .attr("d", path);

            gDraw.append("g")
                .attr("class", "boundary")
                .selectAll("boundary")
                .data([topojson.feature(world, world.objects.countries)])
                .enter().append("path")
                .attr("d", path);

            gDraw.append("g")
                .attr("class", "graticule")
                .selectAll("path")
                .data(graticule.lines)
                .enter().append("path")
                .attr("d", path);

            d3.json("resources/j.json", function (error, json) { //load data json
                var nodes = {};
                var links = json.links;

                // Compute the distinct nodes from the links.
                links.forEach(function (link) {
                    link.source = nodes[link.source] || (nodes[link.source] = {
                        name: link.source,
                        long: link.orLong,
                        lat: link.orLat
                    });
                    link.target = nodes[link.target] || (nodes[link.target] = {
                        name: link.target,
                        long: link.deLong,
                        lat: link.deLat
                    });
                });

                function arc(d) {
                    let coordDe = projection([d.deLong, d.deLat]),
                        coordOr = projection([d.orLong, d.orLat]);
                    let dx = coordDe[0] - coordOr[0],
                        dy = coordDe[1] - coordOr[1],
                        dr = Math.sqrt(dx * dx + dy * dy);
                    return "M" + coordOr[0] + "," + coordOr[1] + "A" + dr + "," + dr + " 0 0,1 " +
                        coordDe[0] + "," + coordDe[1];
                }

                //add curved links, stroke <= number of letters
                link = gDraw.selectAll(".link").data(links).enter()
                    .append("path")
                    .attr("source", function (d) {
                        return d.source.name;
                    }).attr("target", function (d) {
                        return d.target.name;
                    }).attr("class", "link")
                    .attr("fill-opacity", 0)
                    .attr("stroke-width", 1)
                    .attr("stroke", "cyan")
                    .attr("marker-end", "url(#arrow)")
                    .attr("d", function (d) { return arc(d); })
                    .on("mouseover", function (d, i) {
                        d3.select(this).style("stroke", "red");
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html(d.date + "<br/>" + d.close)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    }).on("mouseout", function (d, i) {
                        d3.select(this).style("stroke", "cyan");
                        div.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });

                //add nodes
                node = gDraw.append("g")
                    .selectAll(".node")
                    .data(d3.values(nodes))
                    .attr("class", "node")
                    .enter().append("circle")
                    .attr("r", 1)
                    .attr("cx", function (d) {
                        let aux = [d.long, d.lat];
                        return projection(aux)[0];
                    })
                    .attr("cy", function (d) {
                        let aux = [d.long, d.lat];
                        return projection(aux)[1];
                    })
                    .attr("fill", "GoldenRod");

                // tooltip titles
                node.append("title").text(function (d) { return d.name; });

                // path label
                edgelabels = gDraw.selectAll(".edgelabel")
                    .data(links)
                    .enter()
                    .append("text")
                    .style("pointer-events", "none")
                    .attr("class", "edgelabel")
                    .attr("id", function (d, i) { return "edgelabel" + i; })
                    .style("fill", "#000")
                    .style("font-family", "Arial")
                    .style("font-size", 12);

                // path label text
                edgelabels.append("textPath")
                    .attr("xlink:href", function (d, i) { return "#edgepath" + i; })
                    .style("text-anchor", "middle")
                    .style("pointer-events", "none")
                    .attr("startOffset", "50%")
                    .text(function (d) { return d.mood; });

            });
        });
    </script>
</body>

</html>